# Spellbound Parties ðŸŽ‰

An AI-powered interactive storytelling party game where players collaborate to create an unfolding narrative displayed on a shared screen. Join from your mobile device, contribute to the story, and watch as AI brings your collective imagination to life with generated text and images.

## Features

- **Shared Screen Experience**: Display the evolving story on a TV or projector for all players to enjoy
- **Mobile-First Joining**: Players scan a QR code or enter a game code to join from their phones
- **AI-Generated Narrative**: Powered by OpenRouter's LLM APIs for dynamic story continuation
- **AI-Generated Artwork**: Each story turn includes a custom image generated by OpenAI's image models
- **Real-Time Streaming**: Watch the story unfold word-by-word with Server-Sent Events
- **Turn-Based Gameplay**: The game engine automatically generates new story beats with configurable cooldown periods
- **Custom Avatars**: Players can upload personalized avatars when joining

## Tech Stack

- **Framework**: Next.js 16 (Pages Router)
- **UI**: Radix UI Themes + Tailwind CSS 4
- **State Management**: Redis for persistent game storage
- **Template Engine**: LiquidJS for AI prompt rendering
- **AI Services**:
  - OpenRouter for text generation (configurable models)
  - OpenAI for image generation
- **Real-Time**: Server-Sent Events (SSE) for streaming updates
- **Utilities**: react-qr-code for join QR codes

## Prerequisites

- Node.js 18+ and npm
- Redis instance (local or hosted)
- OpenRouter API key
- OpenAI API key

## Installation

1. Clone the repository:
```bash
git clone <repository-url>
cd spellbound-party
```

2. Install dependencies:
```bash
npm install
```

3. Create `.env.local` file with required environment variables (see below)

4. Start the development server:
```bash
npm run dev
```

5. Open [http://localhost:3000](http://localhost:3000) in your browser

## Environment Variables

Create a `.env.local` file in the project root:

```env
# Redis Configuration
REDIS_HOST=your-redis-host
REDIS_PORT=6379
REDIS_USERNAME=your-redis-username
REDIS_PASSWORD=your-redis-password

# OpenRouter Configuration (Text Generation)
OPENROUTER_API_KEY=your-openrouter-api-key
OPENROUTER_MODEL=openai/gpt-4o-mini

# OpenAI Configuration (Image Generation)
OPENAI_API_KEY=your-openai-api-key
OPENAI_IMAGE_MODEL=gpt-image-1-mini

# Optional Site Metadata
SITE_URL=http://localhost:3000
SITE_NAME=Spellbound Party
```

## Development Commands

```bash
# Start development server
npm run dev

# Build for production
npm run build

# Start production server
npm start

# Run linting
npm run lint
```

## How to Play

### Setting Up a Game

1. Navigate to the home page and create a new game
2. A unique 4-character game code will be generated
3. Open the TV view at `/tv/[gameId]` on your shared screen

### Joining as a Player

1. Scan the QR code displayed on the TV screen, or
2. Visit `/play/[gameId]` and enter your name
3. Optionally upload an avatar (max 300KB)
4. Wait in the lobby until the host starts the game

### Playing

1. The host starts the game from the TV view
2. The AI automatically generates story turns in a loop
3. Each turn includes:
   - Narrative text that continues the story
   - An AI-generated image matching the scene
4. Watch the story unfold on the shared screen
5. (Player input mechanics coming in future updates)

## Project Structure

```
src/
â”œâ”€â”€ pages/
â”‚   â”œâ”€â”€ api/              # API routes
â”‚   â”‚   â””â”€â”€ games/        # Game management & turn streaming
â”‚   â”œâ”€â”€ tv/               # TV screen view
â”‚   â”œâ”€â”€ play/             # Player join view
â”‚   â””â”€â”€ index.tsx         # Home page
â”œâ”€â”€ lib/
â”‚   â”œâ”€â”€ gameStore.ts      # Redis-backed game state management
â”‚   â”œâ”€â”€ redis.ts          # Redis client singleton
â”‚   â””â”€â”€ promptRenderer.ts # LiquidJS template rendering
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ textGeneration.ts # OpenRouter integration
â”‚   â””â”€â”€ imageGeneration.ts# OpenAI image generation
â”œâ”€â”€ templates/            # Liquid templates for AI prompts
â”œâ”€â”€ types/
â”‚   â””â”€â”€ game.ts           # TypeScript type definitions
â””â”€â”€ components/           # React components
```

## Key Architecture Details

### Game State Flow

1. **Lobby Phase**: Players join and wait for the host to start
2. **In-Progress Phase**: Turn engine generates story beats automatically
3. **Turn Generation**: Text and images are generated in parallel and streamed to clients

### Data Model

All game state is stored in Redis with the following structure:

- **GameState**: Contains game status, players array, and turns array
- **Player**: id, name, avatar (base64 data URL)
- **GameTurn**: continuation text, imagePrompt, and generated image URL/data

### Streaming Architecture

The `/api/games/[gameId]/turns/stream` endpoint implements Server-Sent Events:
- Incrementally parses XML tags from the LLM stream
- Starts image generation as soon as `<image_prompt>` is complete
- Streams narrative chunks and partial images to the client
- Emits `turn_complete` when both text and image are ready

### AI Prompt System

Prompts are rendered using Liquid templates ([src/templates/](src/templates/)):
- System prompts include game context and player information
- Templates are rendered with current game state
- The LLM responds with structured XML containing continuation and image prompt

## API Routes

- `POST /api/games` - Create a new game
- `GET /api/games/[gameId]` - Fetch game state
- `POST /api/games/[gameId]/players` - Add a player
- `POST /api/games/[gameId]/start` - Start the game
- `GET /api/games/[gameId]/turns/stream` - SSE stream for turn generation

## Contributing

Contributions are welcome! Please feel free to submit issues or pull requests.

## License

MIT License

## Credits

Built with [Next.js](https://nextjs.org), powered by [OpenRouter](https://openrouter.ai) and [OpenAI](https://openai.com).
